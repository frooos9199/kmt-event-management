const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'eventpro_secret_key_2024';

// Middleware Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
const adminOnly = (req, res, next) => {
  try {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ token Ù…Ù† Ø§Ù„Ù€ header
    const authHeader = req.header('Authorization');
    console.log('ğŸ” Admin auth check - header received:', authHeader ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    
    if (!authHeader) {
      return res.status(401).json({ 
        success: false,
        message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù†' 
      });
    }

    const token = authHeader.replace('Bearer ', '');
    
    if (!token || token === 'null' || token === 'undefined') {
      return res.status(401).json({ 
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­' 
      });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ token
    const decoded = jwt.verify(token, JWT_SECRET);
    console.log('ğŸ” Token decoded for admin check:', { 
      email: decoded.email, 
      role: decoded.role 
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
    if (!decoded.role || decoded.role !== 'admin') {
      console.log('âŒ Access denied - User is not admin:', decoded);
      return res.status(403).json({ 
        success: false,
        message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ - Ù…Ø®ØµØµ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·' 
      });
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø·Ù„Ø¨
    req.user = {
      ...decoded,
      _id: decoded.userId || decoded._id
    };
    
    console.log('âœ… Admin access granted');
    next();

  } catch (error) {
    console.error('ğŸ’¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†:', error);
    
    if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({ 
        success: false,
        message: 'Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù' 
      });
    } else if (error.name === 'TokenExpiredError') {
      return res.status(401).json({ 
        success: false,
        message: 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©' 
      });
    } else {
      return res.status(401).json({ 
        success: false,
        message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©' 
      });
    }
  }
};

module.exports = adminOnly;